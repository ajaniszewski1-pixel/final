<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Planer Budżetu - Django</title>
    <style>
        :root {
            --sheet-green: #13734e;
            --light-green: #e6f4ea;
            --border-color: #dadce0;
            --income-blue: #185abc;
            --expense-red: #d93025;
            --savings-gold: #f9ab00;
            --text-dark: #202124;
        }

        html, body {
            height: 100vh; margin: 0; padding: 0;
            overflow: hidden; font-family: 'Segoe UI', sans-serif;
            background-color: #f8f9fa; color: var(--text-dark);
        }

        body { display: flex; flex-direction: column; padding: 10px; gap: 12px; box-sizing: border-box; }

        .card {
            background: white; border: 1px solid var(--border-color);
            border-radius: 4px; display: flex; flex-direction: column;
            overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .section-header {
            background-color: var(--sheet-green); color: white;
            padding: 6px; font-weight: bold; text-align: center;
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
        }

        .top-row { display: grid; grid-template-columns: 180px 1fr 1fr 1fr; gap: 12px; height: 85px; flex-shrink: 0; }
        .budget-table { width: 100%; height: 100%; border-collapse: collapse; font-size: 11px; }
        .budget-table td { border: 1px solid var(--border-color); padding: 2px 6px; }
        .stat-val { display: flex; align-items: center; justify-content: center; height: 100%; font-size: 22px; font-weight: bold; }

        .btn-logout-table {
            width: 100%; height: 35px; background: var(--expense-red); 
            color: white; border: none; cursor: pointer; font-weight: bold; 
            font-size: 11px; text-transform: uppercase; display: flex;
            align-items: center; justify-content: center;
        }

        .input-row { height: 115px; flex-shrink: 0; border: 1px solid var(--sheet-green); }
        .sheet-table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
        .sheet-table th { background: var(--light-green); border: 1px solid var(--border-color); padding: 5px; color: var(--sheet-green); font-size: 10px; text-transform: uppercase; }
        .input-field { width: 100%; border: none; padding: 10px 5px; font-size: 13px; background: transparent; outline: none; font-weight: 500; text-align: center; }
        
        .btn-save { 
            background: var(--sheet-green); color: white; border: none; 
            padding: 10px 20px; cursor: pointer; border-radius: 4px; 
            font-weight: bold; font-size: 13px;
        }

        .middle-row { display: grid; grid-template-columns: 1fr 1.1fr 1.1fr 1fr; gap: 12px; flex: 1; min-height: 0; }
        .scroll-area { overflow-y: auto; height: 100%; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed; }
        .data-table tr:hover { background-color: #f1f3f4; } /* Podświetlenie wiersza */
        .data-table td { border-bottom: 1px solid var(--border-color); padding: 8px; vertical-align: top; }
        .val-black { text-align: right; font-weight: 600; color: var(--text-dark); white-space: nowrap; }
        .desc-text { color: #666; font-size: 10px; margin-top: 2px; display: block; }

        /* LOGIKA UKRYWANIA PRZYCISKU */
        .btn-delete-container { opacity: 0; transition: opacity 0.2s; margin: 0; }
        .data-table tr:hover .btn-delete-container { opacity: 1; }

        .btn-delete-text {
            background: none; border: none; color: var(--expense-red); 
            font-size: 9px; cursor: pointer; padding: 0; 
            text-decoration: underline; text-transform: uppercase; font-weight: bold;
        }

        .charts-row { display: grid; grid-template-columns: 1.5fr 1fr; gap: 12px; height: 170px; flex-shrink: 0; }
    </style>
</head>
<body>

    <div class="top-row">
        <div class="card">
            <div class="section-header">Panel sterowania</div>
            <table class="budget-table">
                <tr>
                    <td style="background:var(--light-green); width: 40%; font-size: 10px;">Użytkownik</td>
                    <td style="text-align:center; font-weight:bold; font-size: 13px;">{{ user.username }}</td>
                </tr>
                <tr>
                    <td colspan="2" style="padding: 0;">
                        <form action="{% url 'logout' %}" method="post" style="margin: 0;">
                            {% csrf_token %}
                            <button type="submit" class="btn-logout-table">WYLOGUJ SIĘ</button>
                        </form>
                    </td>
                </tr>
            </table>
        </div>
        <div class="card"><div class="section-header">Przychody</div><div class="stat-val" style="color:var(--income-blue)">{{ suma_przychodow|floatformat:2 }} zł</div></div>
        <div class="card"><div class="section-header">Wydatki</div><div class="stat-val" style="color:var(--expense-red)">{{ suma_wydatkow|floatformat:2|cut:"-" }} zł</div></div>
        <div class="card"><div class="section-header">Bilans</div><div class="stat-val" style="color:var(--sheet-green)">{{ bilans|floatformat:2 }} zł</div></div>
    </div>

    <div class="card input-row">
        <div class="section-header">Dodaj nowy wydatek</div>
        <form method="post" style="display:flex; height: 100%; padding: 0 15px; align-items: center; gap: 15px;">
            {% csrf_token %}
            <table class="sheet-table" style="flex:1">
                <thead>
                    <tr>
                        <th style="width:130px">Data</th>
                        <th>Nazwa wydatku</th>
                        <th style="width:100px">Kwota</th>
                        <th style="width:130px">Kategoria</th>
                        <th style="width:120px">Osoba</th>
                        <th>Notatki</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="date" name="data_wydatku" class="input-field" value="{{ dzisiejsza_data }}"></td>
                        <td><input type="text" name="nazwa" class="input-field" placeholder="np. Zakupy spożywcze" required></td>
                        <td><input type="number" step="0.01" name="kwota" class="input-field" placeholder="0.00" required></td>
                        <td>
                            <select name="kategoria" class="input-field" required>
                                <option value="" disabled selected>Wybierz...</option>
                                {% for kat in kategorie %}<option value="{{ kat.id }}">{{ kat.nazwa }}</option>{% endfor %}
                            </select>
                        </td>
                        <td>
                            <select name="uzytkownik" class="input-field" required>
                                {% if user.is_superuser %}
                                    {% for u in uzytkownicy %}<option value="{{ u.id }}" {% if u == user %}selected{% endif %}>{{ u.username }}</option>{% endfor %}
                                {% else %}
                                    <option value="{{ user.id }}">{{ user.username }}</option>
                                {% endif %}
                            </select>
                        </td>
                        <td><input type="text" name="notatki" class="input-field" placeholder="Opcjonalny opis"></td>
                    </tr>
                </tbody>
            </table>
            <div><button type="submit" class="btn-save">ZAPISZ</button></div>
        </form>
    </div>

    <div class="middle-row">
        <div class="card">
            <div class="section-header">Podsumowanie</div>
            <div class="scroll-area">
                <table class="data-table">
                    <tr><td>Przychody łączone</td><td style="text-align:right; color:var(--income-blue); font-weight:bold">+{{ suma_przychodow|floatformat:2 }}</td></tr>
                    <tr><td>Suma wydatków stałych</td><td class="val-black">-{{ suma_stale|floatformat:2|cut:"-" }}</td></tr>
                    <tr><td>Suma wydatków zmiennych</td><td class="val-black">-{{ suma_zmienne|floatformat:2|cut:"-" }}</td></tr>
                    <tr><td>Planowane oszczędności</td><td style="text-align:right; color:var(--savings-gold); font-weight:bold">{{ suma_oszczednosci|floatformat:2 }}</td></tr>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="section-header">Wydatki zmienne</div>
            <div class="scroll-area">
                <table class="data-table">
                    {% for w in wydatki_zmienne %}
                    <tr>
                        <td>
                            <div style="font-weight: 600;">{{ w.nazwa }}</div>
                            <div class="desc-text">{{ w.data_wydatku|date:"d.m.Y" }} | {{ w.uzytkownik.username }}</div>
                        </td>
                        <td class="val-black">
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <span>-{{ w.kwota|floatformat:2|cut:"-" }}</span>
                                <div class="btn-delete-container">
                                    <form action="{% url 'usun_wydatek' w.pk %}" method="post" onsubmit="return confirm('Usunąć?');" style="margin:0;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-delete-text">[usuń]</button>
                                    </form>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <div class="card">
            <div class="section-header">Rachunki stałe</div>
            <div class="scroll-area">
                <table class="data-table">
                    {% for w in wydatki_stale %}
                    <tr>
                        <td>
                            <div style="font-weight: 600;">{{ w.nazwa }}</div>
                            <div class="desc-text">{{ w.data_wydatku|date:"d.m.Y" }} | {{ w.uzytkownik.username }}</div>
                        </td>
                        <td class="val-black">
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <span>-{{ w.kwota|floatformat:2|cut:"-" }}</span>
                                <div class="btn-delete-container">
                                    <form action="{% url 'usun_wydatek' w.pk %}" method="post" onsubmit="return confirm('Usunąć?');" style="margin:0;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-delete-text">[usuń]</button>
                                    </form>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <div class="card">
            <div class="section-header">Oszczędności</div>
            <div class="scroll-area">
                <table class="data-table">
                    {% for o in oszczednosci %}
                    <tr>
                        <td>
                            <div style="font-weight: 600;">{{ o.nazwa }}</div>
                            <div class="desc-text">Dla: {{ o.uzytkownik.username }}</div>
                        </td>
                        <td style="text-align:right; font-weight:bold; color:var(--savings-gold)">{{ o.kwota_docelowa|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>

    <div class="charts-row">
        <div class="card" style="padding:5px"><canvas id="barChart"></canvas></div>
        <div class="card" style="padding:5px"><canvas id="pieChart"></canvas></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const clean = (val) => Math.abs(parseFloat(val.toString().replace(',', '.')) || 0);
        const opt = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };
        
        new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { 
                labels: ['Wpływy', 'Stałe', 'Zmienne', 'Oszczędności'], 
                datasets: [{ 
                    data: [clean("{{ suma_przychodow }}"), clean("{{ suma_stale }}"), clean("{{ suma_zmienne }}"), clean("{{ suma_oszczednosci }}")], 
                    backgroundColor: ['#185abc', '#5f6368', '#d93025', '#f9ab00'] 
                }] 
            },
            options: opt
        });

        new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: { 
                labels: ['Stałe', 'Zmienne', 'Oszczędności'], 
                datasets: [{ 
                    data: [clean("{{ suma_stale }}"), clean("{{ suma_zmienne }}"), clean("{{ suma_oszczednosci }}")], 
                    backgroundColor: ['#5f6368', '#d93025', '#f9ab00'] 
                }] 
            },
            options: { ...opt, plugins: { legend: { display: true, position: 'right' } } }
        });
    </script>
</body>
</html>